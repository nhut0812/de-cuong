// Bi·∫øn to√†n c·ª•c
let allOutlines = [];
let currentFilter = 'all';

// D·ªØ li·ªáu ƒë·ªÅ c∆∞∆°ng (nh√∫ng tr·ª±c ti·∫øp)
const outlinesData = {
  "lastUpdate": "2025-12-16",
  "outlines": [
    {
      "id": 1,
      "subject": "To√°n",
      "grade": "5",
      "description": "ƒê·ªÅ c∆∞∆°ng √¥n t·∫≠p To√°n l·ªõp 5 - H·ªçc k·ª≥ 1",
      "fileName": "De-cuong-Toan-5-HK1.pdf",
      "filePath": "docs/De-cuong-Toan-5-HK1.pdf",
      "fileType": "pdf",
      "icon": "üî¢"
    },
    {
      "id": 2,
      "subject": "Ti·∫øng Vi·ªát",
      "grade": "5",
      "description": "ƒê·ªÅ c∆∞∆°ng √¥n t·∫≠p Ti·∫øng Vi·ªát l·ªõp 5 - H·ªçc k·ª≥ 1",
      "fileName": "De-cuong-Tieng-Viet-5-HK1.pdf",
      "filePath": "docs/De-cuong-Tieng-Viet-5-HK1.pdf",
      "fileType": "pdf",
      "icon": "üìñ"
    },
    {
      "id": 3,
      "subject": "Khoa H·ªçc",
      "grade": "5",
      "description": "ƒê·ªÅ c∆∞∆°ng √¥n t·∫≠p Khoa h·ªçc l·ªõp 5 - H·ªçc k·ª≥ 1",
      "fileName": "De-cuong-Khoa-hoc-5-HK1.pdf",
      "filePath": "docs/De-cuong-Khoa-hoc-5-HK1.pdf",
      "fileType": "pdf",
      "icon": "üî¨"
    },
    {
      "id": 4,
      "subject": "Ti·∫øng Anh",
      "grade": "5",
      "description": "ƒê·ªÅ c∆∞∆°ng √¥n t·∫≠p Ti·∫øng Anh l·ªõp 5 - H·ªçc k·ª≥ 1",
      "fileName": "De-cuong-Tieng-Anh-5-HK1.docx",
      "filePath": "docs/De-cuong-Tieng-Anh-5-HK1.docx",
      "fileType": "docx",
      "icon": "üåç"
    },
    {
      "id": 5,
      "subject": "ƒê·∫°o ƒê·ª©c",
      "grade": "5",
      "description": "ƒê·ªÅ c∆∞∆°ng √¥n t·∫≠p ƒê·∫°o ƒë·ª©c l·ªõp 5 - H·ªçc k·ª≥ 1",
      "fileName": "De-cuong-Dao-duc-5-HK1.pdf",
      "filePath": "docs/De-cuong-Dao-duc-5-HK1.pdf",
      "fileType": "pdf",
      "icon": "üíù"
    },
    {
      "id": 6,
      "subject": "L·ªãch S·ª≠ & ƒê·ªãa L√Ω",
      "grade": "5",
      "description": "ƒê·ªÅ c∆∞∆°ng √¥n t·∫≠p L·ªãch s·ª≠ v√† ƒê·ªãa l√Ω l·ªõp 5 - H·ªçc k·ª≥ 1",
      "fileName": "De-cuong-LSDL-5-HK1.pdf",
      "filePath": "docs/De-cuong-LSDL-5-HK1.pdf",
      "fileType": "pdf",
      "icon": "üåè"
    }
  ]
};

// H√†m t·∫£i d·ªØ li·ªáu ƒë·ªÅ c∆∞∆°ng
function loadOutlines() {
    // N·∫øu c√≥ Firebase, load t·ª´ Firebase
    if (typeof useFirebase !== 'undefined' && useFirebase && database) {
        loadFromFirebase();
    } else {
        // Kh√¥ng c√≥ Firebase, d√πng d·ªØ li·ªáu local
        loadFromLocal();
    }
}

// Load t·ª´ Firebase (t·ª± ƒë·ªông ƒë·ªìng b·ªô)
function loadFromFirebase() {
    const outlinesRef = database.ref('outlines');
    
    outlinesRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data && data.items && data.items.length > 0) {
            allOutlines = data.items;
            
            // C·∫≠p nh·∫≠t ng√†y
            const lastUpdateElement = document.getElementById('lastUpdate');
            if (lastUpdateElement) {
                lastUpdateElement.textContent = formatDate(data.lastUpdate || new Date().toISOString().split('T')[0]);
            }
            
            displayOutlines(allOutlines);
            console.log('‚úÖ ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ Firebase');
        } else {
            // Firebase tr·ªëng, kh·ªüi t·∫°o d·ªØ li·ªáu m·∫∑c ƒë·ªãnh
            console.log('üìù Firebase tr·ªëng, ƒëang kh·ªüi t·∫°o d·ªØ li·ªáu m·∫´u...');
            const initialData = {
                lastUpdate: outlinesData.lastUpdate,
                items: outlinesData.outlines
            };
            outlinesRef.set(initialData).then(() => {
                console.log('‚úÖ ƒê√£ kh·ªüi t·∫°o d·ªØ li·ªáu m·∫´u v√†o Firebase');
                allOutlines = outlinesData.outlines;
                displayOutlines(allOutlines);
            }).catch((error) => {
                console.error('‚ùå L·ªói kh·ªüi t·∫°o Firebase:', error);
                loadFromLocal();
            });
        }
    }, (error) => {
        console.error('‚ùå L·ªói Firebase:', error);
        loadFromLocal();
    });
}

// Load t·ª´ d·ªØ li·ªáu local
function loadFromLocal() {
    try {
        allOutlines = outlinesData.outlines;
        
        // C·∫≠p nh·∫≠t ng√†y c·∫≠p nh·∫≠t
        const lastUpdateElement = document.getElementById('lastUpdate');
        if (lastUpdateElement) {
            lastUpdateElement.textContent = formatDate(outlinesData.lastUpdate);
        }
        
        displayOutlines(allOutlines);
    } catch (error) {
        console.error('L·ªói:', error);
        displayError();
    }
}

// H√†m hi·ªÉn th·ªã danh s√°ch ƒë·ªÅ c∆∞∆°ng
function displayOutlines(outlines) {
    const container = document.getElementById('outlinesList');
    const totalCountElement = document.getElementById('totalCount');
    
    if (!container) return;
    
    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
    if (totalCountElement) {
        totalCountElement.textContent = outlines.length;
    }
    
    // N·∫øu kh√¥ng c√≥ ƒë·ªÅ c∆∞∆°ng
    if (outlines.length === 0) {
        container.innerHTML = `
            <div class="no-results">
                <p>Kh√¥ng t√¨m th·∫•y ƒë·ªÅ c∆∞∆°ng n√†o!</p>
            </div>
        `;
        return;
    }
    
    // T·∫°o HTML cho c√°c card
    const cardsHTML = outlines.map(outline => createOutlineCard(outline)).join('');
    container.innerHTML = cardsHTML;
    
    // Th√™m s·ª± ki·ªán click cho c√°c card
    addCardClickEvents();
}
// H√†m t·∫°o HTML cho m·ªôt card ƒë·ªÅ c∆∞∆°ng
function createOutlineCard(outline) {
    const gradeTag = outline.grade ? `<span class="grade-tag">L·ªõp ${outline.grade}</span>` : '';
    
    return `
        <div class="outline-card" data-id="${outline.id}" data-file="${outline.filePath}" data-grade="${outline.grade || ''}">
            <h3>
                <span class="subject-icon">${outline.icon}</span>
                ${outline.subject}
                ${gradeTag}
            </h3>
            <p class="description">${outline.description}</p>
            <div class="file-info">
                <span class="file-type ${outline.fileType}">${outline.fileType.toUpperCase()}</span>
                <span>${outline.fileName}</span>
            </div>
            <a href="${outline.filePath}" 
               class="download-btn" 
               download="${outline.fileName}"
               onclick="event.stopPropagation()">
                üì• T·∫£i xu·ªëng
            </a>
        </div>
    `;
}   `;
}

// H√†m th√™m s·ª± ki·ªán click cho c√°c card
function addCardClickEvents() {
    const cards = document.querySelectorAll('.outline-card');
    cards.forEach(card => {
        card.addEventListener('click', function(e) {
            // N·∫øu click v√†o button download th√¨ kh√¥ng l√†m g√¨
            if (e.target.classList.contains('download-btn')) {
                return;
            }
            
            // L·∫•y ƒë∆∞·ªùng d·∫´n file v√† t·∫£i xu·ªëng
            const filePath = this.getAttribute('data-file');
            const fileName = this.querySelector('.file-info span:last-child').textContent;
            downloadFile(filePath, fileName);
        });
    });
}

// H√†m t·∫£i file
function downloadFile(filePath, fileName) {
    const link = document.createElement('a');
    link.href = filePath;
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
// H√†m t√¨m ki·∫øm
function searchOutlines(searchTerm) {
    let filtered = allOutlines;
    
    // L·ªçc theo kh·ªëi/l·ªõp
    if (currentFilter !== 'all') {
        filtered = filtered.filter(outline => outline.grade === currentFilter);
    }
    
    // L·ªçc theo t·ª´ kh√≥a t√¨m ki·∫øm
    if (searchTerm) {
        const searchString = searchTerm.toLowerCase().trim();
        filtered = filtered.filter(outline => {
            return (
                outline.subject.toLowerCase().includes(searchString) ||
                outline.description.toLowerCase().includes(searchString) ||
                outline.fileName.toLowerCase().includes(searchString)
            );
        });
    }
    
    displayOutlines(filtered);
}

// H√†m l·ªçc theo kh·ªëi/l·ªõp
function filterByGrade(grade) {
    currentFilter = grade;
    
    // Update active button
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-grade') === grade) {
            btn.classList.add('active');
        }
    });
    
    // Apply filter
    const searchTerm = document.getElementById('searchInput').value;
    searchOutlines(searchTerm);
}   });
    
    displayOutlines(filtered);
    // Th√™m s·ª± ki·ªán t√¨m ki·∫øm
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        // T√¨m ki·∫øm khi g√µ (debounce ƒë·ªÉ t·ªëi ∆∞u hi·ªáu nƒÉng)
        let debounceTimer;
        searchInput.addEventListener('input', function(e) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                searchOutlines(e.target.value);
            }, 300);
        });
    }
    
    // Th√™m s·ª± ki·ªán cho filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const grade = this.getAttribute('data-grade');
            filterByGrade(grade);
        });
    });
}); if (container) {
        container.innerHTML = `
            <div class="no-results">
                <p style="color: #e74c3c;">‚ùå ƒê√£ x·∫£y ra l·ªói khi t·∫£i ƒë·ªÅ c∆∞∆°ng!</p>
                <p style="font-size: 0.9rem; margin-top: 10px;">Vui l√≤ng th·ª≠ l·∫°i sau ho·∫∑c li√™n h·ªá qu·∫£n tr·ªã vi√™n.</p>
            </div>
        `;
    }
}

// Kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c t·∫£i
document.addEventListener('DOMContentLoaded', function() {
    // T·∫£i danh s√°ch ƒë·ªÅ c∆∞∆°ng
    loadOutlines();
    
    // Th√™m s·ª± ki·ªán t√¨m ki·∫øm
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        // T√¨m ki·∫øm khi g√µ (debounce ƒë·ªÉ t·ªëi ∆∞u hi·ªáu nƒÉng)
        let debounceTimer;
        searchInput.addEventListener('input', function(e) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                searchOutlines(e.target.value);
            }, 300);
        });
    }
});

// H√†m l√†m m·ªõi danh s√°ch (c√≥ th·ªÉ d√πng khi c·∫ßn)
function refreshOutlines() {
    loadOutlines();
}
